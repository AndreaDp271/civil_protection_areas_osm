<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Aree Protezione Civile - OSM</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Tailwind CSS per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .loader {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .leaflet-interactive {
            transition: fill-opacity 0.2s, stroke-width 0.2s;
        }
        .leaflet-interactive:hover {
            fill-opacity: 0.6 !important;
            stroke-width: 4px !important;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Overlay di caricamento -->
    <div id="loader" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <p id="loader-text" class="text-gray-700 font-semibold text-center">Caricamento dati in corso...</p>
        </div>
    </div>

    <!-- Barra di Ricerca Superiore -->
    <div class="fixed top-4 left-1/2 -translate-x-1/2 z-[1001] w-[90%] max-w-md">
        <div class="bg-white rounded-full shadow-2xl flex items-center px-4 py-2 border border-gray-200">
            <i data-lucide="search" class="text-gray-400 w-5 h-5 mr-2"></i>
            <input type="text" id="search-input" placeholder="Cerca Città o CAP (es: Roma, 00100)..." 
                   class="flex-1 bg-transparent border-none focus:outline-none text-sm text-gray-700 py-1">
            <button onclick="searchLocation()" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full transition ml-2">
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

    <!-- Pannello Laterale Destro (Filtri) -->
    <div class="fixed top-20 right-4 z-[1000] w-64 md:w-72 space-y-4">
        <div class="bg-white p-5 rounded-xl shadow-2xl border border-gray-200">
            <h1 class="text-lg font-bold text-blue-900 flex items-center gap-2 mb-2">
                <i data-lucide="shield-alert"></i> Emergenza CPA
            </h1>
            
            <div class="space-y-3">
                <button onclick="fetchData()" class="w-full bg-slate-800 hover:bg-slate-900 text-white py-2 px-4 rounded-lg font-medium transition flex items-center justify-center gap-2 text-sm">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Aggiorna in quest'area
                </button>
                
                <div class="border-t pt-3">
                    <p class="text-xs font-bold text-gray-400 mb-3 uppercase">Legenda Aree:</p>
                    <div class="space-y-2 text-xs">
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" checked class="filter-check w-4 h-4 rounded" value="waiting">
                            <span class="w-4 h-4 rounded-sm bg-green-500 border border-green-700"></span> 
                            <span class="group-hover:text-blue-600 transition text-gray-700 font-medium">Attesa (Waiting)</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" checked class="filter-check w-4 h-4 rounded" value="shelter">
                            <span class="w-4 h-4 rounded-sm bg-red-600 border border-red-800"></span> 
                            <span class="group-hover:text-blue-600 transition text-gray-700 font-medium">Ricovero (Shelter)</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" checked class="filter-check w-4 h-4 rounded" value="staging">
                            <span class="w-4 h-4 rounded-sm bg-yellow-400 border border-yellow-600"></span> 
                            <span class="group-hover:text-blue-600 transition text-gray-700 font-medium">Ammassamento (Staging)</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" checked class="filter-check w-4 h-4 rounded" value="logistic">
                            <span class="w-4 h-4 rounded-sm bg-purple-600 border border-purple-800"></span> 
                            <span class="group-hover:text-blue-600 transition text-gray-700 font-medium">Logistica (Entry)</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Box (Dettagli area cliccata) -->
        <div id="info-box" class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 hidden">
            <h3 class="font-bold text-gray-800 border-b pb-2 mb-2 text-xs flex justify-between items-center">
                Dettagli Poligono
                <button onclick="document.getElementById('info-box').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">×</button>
            </h3>
            <div id="info-content" class="text-[10px] space-y-1 text-gray-600 max-h-40 overflow-y-auto font-mono"></div>
        </div>
    </div>

    <!-- Pulsante Geolocalizzazione Rapida -->
    <div class="fixed bottom-8 left-4 z-[1000]">
        <button onclick="locateUser()" class="bg-white p-3 rounded-full shadow-xl border border-gray-200 text-blue-600 hover:bg-blue-50 transition">
            <i data-lucide="map-pin"></i>
        </button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        lucide.createIcons();

        // Inizializzazione mappa
        const map = L.map('map', {
            zoomControl: false
        }).setView([41.9028, 12.4964], 14);
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        const layers = {
            waiting: L.layerGroup().addTo(map),
            shelter: L.layerGroup().addTo(map),
            staging: L.layerGroup().addTo(map),
            logistic: L.layerGroup().addTo(map),
            other: L.layerGroup().addTo(map)
        };

        const config = {
            waiting: { color: '#22c55e', label: 'Attesa (Waiting Area)' },
            shelter: { color: '#dc2626', label: 'Ricovero (Shelter Area)' },
            staging: { color: '#eab308', label: 'Ammassamento (Staging Area)' },
            logistic: { color: '#9333ea', label: 'Logistica (Entry Rescue)' }
        };

        // Funzione per cercare una località tramite Nominatim
        async function searchLocation() {
            const input = document.getElementById('search-input').value;
            if (!input) return;

            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input)}&limit=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const result = data[0];
                    map.setView([result.lat, result.lon], 14);
                    fetchData(); // Scarica i dati per la nuova area
                } else {
                    alert("Località non trovata.");
                }
            } catch (error) {
                alert("Errore nella ricerca.");
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Gestione tasto Invio nell'input di ricerca
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchLocation();
        });

        // Funzione di localizzazione
        function locateUser() {
            map.locate({setView: true, maxZoom: 15});
        }

        function getAreaType(tags) {
            if (tags['emergency:waiting_area'] === 'yes') return 'waiting';
            if (tags['emergency:shelter_area'] === 'yes') return 'shelter';
            if (tags['emergency:staging_area_rescue'] === 'yes') return 'staging';
            if (tags['emergency:logistic_entry_rescue'] === 'yes') return 'logistic';
            return 'other';
        }

        function createFeature(el, nodesMap) {
            const tags = el.tags || {};
            const type = getAreaType(tags);
            const style = config[type] || { color: '#64748b' };
            
            if (el.type !== 'way' || !el.nodes) return;

            const coordinates = el.nodes.map(nodeId => {
                const node = nodesMap[nodeId];
                return node ? [node.lat, node.lon] : null;
            }).filter(c => c !== null);

            if (coordinates.length < 3) return; 

            const polygon = L.polygon(coordinates, {
                color: style.color,
                fillColor: style.color,
                fillOpacity: 0.35,
                weight: 3
            });

            const popupContent = `
                <div class="p-1 min-w-[180px]">
                    <div class="text-[9px] uppercase font-black text-gray-400 tracking-tighter">${style.label}</div>
                    <strong class="text-sm block border-b pb-1 mb-1 text-slate-800">${tags.name || 'Area Poligonale'}</strong>
                    <div class="text-[11px] text-gray-600">
                        ${tags.operator ? `<div><b>Gestore:</b> ${tags.operator}</div>` : ''}
                        ${tags.capacity ? `<div><b>Capacità:</b> ${tags.capacity}</div>` : ''}
                    </div>
                    <a href="https://www.openstreetmap.org/way/${el.id}" target="_blank" class="text-blue-600 text-[10px] font-bold mt-2 block hover:underline italic">Apri in OSM ↗</a>
                </div>
            `;

            polygon.bindPopup(popupContent);
            
            polygon.on('click', () => {
                const infoBox = document.getElementById('info-box');
                const infoContent = document.getElementById('info-content');
                infoBox.classList.remove('hidden');
                
                let html = `<div class="font-bold text-slate-800 mb-2 border-b pb-1 text-xs">${tags.name || 'Metadati'}</div>`;
                for (let key in tags) {
                    html += `<div class="flex justify-between gap-3 border-b border-gray-50 py-1">
                        <span class="text-gray-400" style="font-size: 8px;">${key}</span>
                        <span class="text-right font-medium text-slate-700">${tags[key]}</span>
                    </div>`;
                }
                infoContent.innerHTML = html;
            });

            if (layers[type]) polygon.addTo(layers[type]);
            else polygon.addTo(layers.other);
        }

        async function fetchData() {
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            const query = `[out:json][timeout:30];
                (
                  way["emergency:waiting_area"="yes"](${bbox});
                  way["emergency:shelter_area"="yes"](${bbox});
                  way["emergency:staging_area_rescue"="yes"](${bbox});
                  way["emergency:logistic_entry_rescue"="yes"](${bbox});
                );
                out body;
                >;
                out skel qt;`;

            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');

            try {
                const response = await fetch("https://overpass-api.de/api/interpreter", {
                    method: 'POST',
                    body: 'data=' + encodeURIComponent(query),
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });

                if (!response.ok) throw new Error("Errore API Overpass.");
                
                const data = await response.json();
                
                const nodesMap = {};
                data.elements.forEach(el => {
                    if (el.type === 'node') nodesMap[el.id] = el;
                });

                Object.values(layers).forEach(l => l.clearLayers());

                const features = data.elements.filter(el => el.type === 'way' && el.tags && getAreaType(el.tags) !== 'other');

                if (features.length === 0) {
                    // Non usiamo alert qui per non disturbare la navigazione fluida
                    console.log("Nessun poligono CPA trovato in quest'area.");
                } else {
                    features.forEach(f => createFeature(f, nodesMap));
                }

            } catch (error) {
                console.error(error);
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Filtri checkbox
        document.querySelectorAll('.filter-check').forEach(check => {
            check.addEventListener('change', (e) => {
                const type = e.target.value;
                if (e.target.checked) map.addLayer(layers[type]);
                else map.removeLayer(layers[type]);
            });
        });

        // Avvio: localizza l'utente o carica Roma come fallback
        map.on('locationfound', (e) => {
            fetchData();
        });

        map.on('locationerror', () => {
            fetchData();
        });

        locateUser();

    </script>
</body>
</html>
